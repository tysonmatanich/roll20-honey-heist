<div class="sheet-honey-heist">
    <div class="sheet-info">
        <h1>Honey Heist</h1>
        <div class="sheet-inputs">
            <div class="sheet-input">
                <label for="attr_character_name">bear name</label>
                <input type="text" class="sheet-open" id="attr_character_name" name="attr_character_name" />
            </div>
            <div class="sheet-input">
                <label for="attr_type">bear type / skill</label>
                <input type="text" class="sheet-open" id="attr_type" name="attr_type" />
            </div>
            <div class="sheet-input">
                <label for="attr_desc">descriptor</label>
                <input type="text" class="sheet-open" id="attr_desc" name="attr_desc" />
            </div>
            <div class="sheet-input">
                <label for="attr_role">role</label>
                <input type="text" class="sheet-open" id="attr_role" name="attr_role" />
            </div>
            <div class="sheet-input">
                <label for="attr_attire">attire</label>
                <input type="text" class="sheet-open" id="attr_attire" name="attr_attire" />
            </div>
            <div class="sheet-input">
                <label for="attr_custom_value"><span name="attr_custom_label">flaw</span></label>
                <input type="text" class="sheet-open" id="attr_custom_value" name="attr_custom_value" />
            </div>
            <div class="sheet-input sheet-input-full">
                <label for="attr_notes">notes</label>
                <textarea class="sheet-open" id="attr_notes" name="attr_notes"></textarea>
            </div>
        </div>
    </div>

    <div class="sheet-stats">
        <div class="sheet-stats-header">
            <label>Bear</label>
            <label>Criminal</label>
        </div>
        <div class="sheet-stat-control">
            <button class="sheet-frustration" type="action" name="act_frustration" title="Frustration (+1 bear)">+</button>
            
            <input type="hidden" name="attr_bear" value="3" />
            <img class="sheet-stat-bear" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/bear.png?raw=true" alt="bear" />
            <img class="sheet-stat-bear" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/bear.png?raw=true" alt="bear" />
            <img class="sheet-stat-bear" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/bear.png?raw=true" alt="bear" />
            <img class="sheet-stat-bear" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/bear.png?raw=true" alt="bear" />
            <img class="sheet-stat-bear" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/bear.png?raw=true" alt="bear" />
            <img class="sheet-stat-bear" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/bear.png?raw=true" alt="bear" />
            
            <input type="hidden" name="attr_criminal" value="3" />
            <img class="sheet-stat-criminal" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/criminal.png?raw=true" alt="criminal" />
            <img class="sheet-stat-criminal" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/criminal.png?raw=true" alt="criminal" />
            <img class="sheet-stat-criminal" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/criminal.png?raw=true" alt="criminal" />
            <img class="sheet-stat-criminal" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/criminal.png?raw=true" alt="criminal" />
            <img class="sheet-stat-criminal" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/criminal.png?raw=true" alt="criminal" />
            <img class="sheet-stat-criminal" src="https://github.com/tysonmatanich/roll20-honey-heist/blob/main/images/criminal.png?raw=true" alt="criminal" />

            <button class="sheet-greed" type="action" name="act_greed" title="Greed (+1 criminal)">+</button>
        </div>
        <div class="sheet-roll-container">
            <div class="sheet-roll-group">
                <button type="roll" class="sheet-roll" title="Roll Bear (1d6)" name="roll-bear" value="&{template:Skill} {{Bear Name= @{character_name}}} {{statName=Bear}} {{bear=true}} {{diceRoll=[[1d6]]}} {{playerStat=[[@{bear}]]}}">
                    bear
                </button>
                <button type="roll" class="sheet-roll sheet-roll-special" title="Roll Special Bear (2d6)" name="roll-bear-skilled" value="&{template:Skill} {{Bear Name= @{character_name}}} {{statName=Bear}} {{bear=true}} {{special=Special}} {{diceRoll=[[2d6kl1]]}} {{playerStat=[[@{bear}]]}}">
                    bear special
                </button>
            </div>
            <div class="sheet-roll-group">
                <button type="roll" class="sheet-roll" title="Roll Criminal (1d6)" name="roll-criminal" value="&{template:Skill} {{Bear Name= @{character_name}}} {{statName=Criminal}} {{criminal=true}} {{diceRoll=[[1d6]]}} {{playerStat=[[@{criminal}]]}}">
                    criminal
                </button>
                <button type="roll" class="sheet-roll sheet-roll-special" title="Roll Special Criminal (2d6)" name="roll-criminal-skilled" value="&{template:Skill} {{Bear Name= @{character_name}}} {{statName=Criminal}} {{criminal=true}} {{special=Special}} {{diceRoll=[[2d6kl1]]}} {{playerStat=[[@{criminal}]]}}">
                    criminal special
                </button>
            </div>
        </div>
    </div>

    <div class="sheet-rules">
        <h2>
            Rules Summary
            <a href="https://docs.google.com/viewer?url=https://github.com/tysonmatanich/roll20-honey-heist/blob/main/honey-heist.pdf?raw=true">view full rules</a>
        </h2>
        <p>You’re not a talking bear, per se, but you can sort of mangle human speech through your bear mouth, maybe?</p>
        <h3>Stats</h3>
        <p>You have two stats. Each starts with 3 points.</p>
        <p><strong>Bear:</strong> Use to maul stuff, run & climb, shrug off damage, scare people, and generally do bear stuff.</p>
        <p><strong>Criminal:</strong> Use to do anything not directly related to being a bear.</p>
        <h3>Actions</h3>
        <p>When you act, and the outcome is in doubt, roll a D6. If it’s equal to or under the relevant stat, you succeed. If it’s over the stat, you fail. If you’re using your bear special-skill or doing something related to your role, roll 2 D6 and pick the lowest.</p>
        <h3>Changing Stats</h3>
        <p><strong>Frustration:</strong> When the plan fails and you run into difficulty, move one point from Criminal into Bear.</p>
        <p><strong>Greed:</strong> When the plan goes off without a hitch, move one point from Bear into Criminal.</p>
        <p>You can voluntarily move one point from Bear to Criminal by doing a flashback scene in which you and the other bears plan out the heist over coffee and cigarettes in the back room of a seedy bar. You can voluntarily move one point of Criminal into Bear by eating a load of honey.</p>
        <h3> The End</h3>
        <p>If your criminal stat ever reaches 6, you are lured into a life of crime and betray the party.</p>
        <p>If your bear stat ever reaches 6, you flip out bear-style and lose it. Presumable to be picked up by animal control in half an hour or so.</p>
        <br/>
        <p>Credits: Honey Heist by <a href="https://twitter.com/gshowitt">Grant Howitt</a>, Roll20 template by <a href="https://www.matanich.com/about/">Tyson Matanich</a>, view on <a href="https://github.com/tysonmatanich/roll20-honey-heist/">GitHub</a>.</p>
    </div>
</div>

<script type="text/worker">
    const isValidPlayerStats = function (bear, criminal) {
        return (
            bear + criminal != 6 || bear < 0 || bear > 6 || criminal < 0 || criminal > 6
        );
    };

    const updatePlayerStats = function (eventName) {
        getAttrs(["bear", "criminal"], function (values) {
            let bear = parseInt(values.bear) || 0;
            let criminal = parseInt(values.criminal) || 0;

            if (isValidPlayerStats(bear, criminal)) {
                bear = 3;
                criminal = 3;
            }

            if (eventName == "frustration") {
                if (bear < 6) {
                    bear += 1;
                    criminal -= 1;
                }
            } else if (eventName == "greed") {
                if (criminal < 6) {
                    bear -= 1;
                    criminal += 1;
                }
            }

            setattrs({
                bear: bear,
                criminal: criminal,
            });
        });
    };

    on("sheet:opened", function () {
        if (isValidPlayerStats(parseInt(values.bear), parseInt(values.criminal))) {
            setattrs({
                bear: 3,
                criminal: 3,
            });
        }
    });

    on("clicked:frustration", function () {
        updatePlayerStats("frustration");
    });

    on("clicked:greed", function () {
        updatePlayerStats("greed");
    });      
</script>

<rolltemplate class="sheet-rolltemplate-Skill">
    <div class="sheet-result-container">
        {{#^rollGreater() diceRoll playerStat}}
            <div class="sheet-result">Success!</div>
        {{/^rollGreater() diceRoll playerStat}}

        {{#rollGreater() diceRoll playerStat}}
            <div class="sheet-result">Fail...</div>
        {{/rollGreater() diceRoll playerStat}}

        <div class="sheet-action-type">{{advantage}} {{statName}} Action</div>

        <div class="sheet-character">by {{Bear Name}}</div>

        <div class="sheet-values">
            {{ #diceRoll }}
                {{#^rollGreater() diceRoll playerStat}}
                    <div class="sheet-success"></div>
                {{/^rollGreater() diceRoll playerStat}}

                {{#rollGreater() diceRoll playerStat}}
                    <div class="sheet-fail"></div>
                {{/rollGreater() diceRoll playerStat}}

                <div class="sheet-value-result">
                    {{diceRoll}}
                    <span class="sheet-compare-symbol">≤</span>
                    <span class="sheet-player-stat">{{playerStat}}</span>
                </div>
            {{ /diceRoll }}
        </div>

        {{#bear}}
            <div class="sheet-bear"></div>
        {{/bear}}
        {{#criminal}}
            <div class="sheet-criminal"></div>
        {{/criminal}}
    </div>
</rolltemplate>