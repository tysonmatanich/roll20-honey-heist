<div class="sheet-honey-heist">
    <div class="info">
        <h1><span name="attr_game_name">Honey Heist</span></h1>
        <div class="inputs">
            <div class="input">
                <label for="attr_character_name">name</label>
                <input type="text" id="attr_character_name" name="attr_character_name" />
            </div>
            <div class="input">
                <label for="attr_text_1"><span name="attr_label_1">type / skill</span></label>
                <input type="text" id="attr_text_1" name="attr_text_1" />
            </div>
            <div class="input">
                <input type="hidden" name="attr_label_2" value="descriptor" />
                <label for="attr_text_2"><span name="attr_label_2">descriptor</span></label>
                <input type="text" id="attr_text_2" name="attr_text_2" />
            </div>
            <div class="input">
                <input type="hidden" name="attr_label_3" value="role" />
                <label for="attr_text_3"><span name="attr_label_3">role</span></label>
                <input type="text" id="attr_text_3" name="attr_text_3" />
            </div>
            <div class="input">
                <input type="hidden" name="attr_label_4" value="attire" />
                <label for="attr_text_4"><span name="attr_label_4">attire</span></label>
                <input type="text" id="attr_text_4" name="attr_text_4" />
            </div>
            <div class="input">
                <input type="hidden" name="attr_label_5" value="flaw" />
                <label for="attr_text_5"><span name="attr_label_5">flaw</span></label>
                <input type="text" id="attr_text_5" name="attr_text_5" />
            </div>
            <div class="input input-full">
                <input type="hidden" name="attr_label_notes" value="notes" />
                <label for="attr_text_notes"><span name="attr_label_notes">notes</span></label>
                <textarea id="attr_text_notes" name="attr_text_notes"></textarea>
            </div>
        </div>
    </div>

    <div class="stats">
        <div class="stats-header">
            <label><span name="attr_primary_type">Bear</span></label>
            <label><span name="attr_secondary_type">Criminal</span></label>
        </div>
        <div class="stat-control">
            <input type="hidden" name="attr_is_primary_bear" value="1" />
            <input type="hidden" name="attr_primary" value="3" />
            <input type="hidden" name="attr_secondary" value="3" />

            <button type="action" name="act_primary_modifier" title="+1 Primary">+</button>

            <div class="stat-primary"></div>
            <div class="stat-primary"></div>
            <div class="stat-primary"></div>
            <div class="stat-primary"></div>
            <div class="stat-primary"></div>
            <div class="stat-primary"></div>

            <div class="stat-secondary"></div>
            <div class="stat-secondary"></div>
            <div class="stat-secondary"></div>
            <div class="stat-secondary"></div>
            <div class="stat-secondary"></div>
            <div class="stat-secondary"></div>

            <button type="action" name="act_secondary_modifier" title="+1 Secondary">+</button>
        </div>
        <div class="roll-container">
            <div class="roll-group">
                <button type="roll" class="button" title="Roll Primary (1d6)" name="roll_primary"
                    value="&{template:Skill} {{characterName=@{character_name}}} {{characterType=@{primary_type}}} {{isPrimary=[[1]]}} {{isPrimaryBear=[[@{is_primary_bear}]]}} {{diceRoll=[[1d6]]}} {{playerStat=[[@{primary}]]}}">
                    <span name="attr_primary_type">Bear</span>
                </button>
                <button type="roll" class="button special" title="Roll Special Primary (2d6)" name="roll_primary_advantage"
                    value="&{template:Skill} {{characterName=@{character_name}}} {{characterType=@{primary_type}}} {{isPrimary=[[1]]}} {{isPrimaryBear=[[@{is_primary_bear}]]}} {{special=Special}} {{diceRoll=[[2d6kl1]]}} {{playerStat=[[@{primary}]]}}">
                    <span name="attr_primary_type">Bear</span> special
                </button>
            </div>
            <div class="roll-group">
                <button type="roll" class="button" title="Roll Secondary (1d6)" name="roll_secondary"
                    value="&{template:Skill} {{characterName=@{character_name}}} {{characterType=@{secondary_type}}} {{isSecondary=[[1]]}} {{isPrimaryBear=[[@{is_primary_bear}]]}} {{diceRoll=[[1d6]]}} {{playerStat=[[@{secondary}]]}}">
                    <span name="attr_secondary_type">Criminal</span>
                </button>
                <button type="roll" class="button special" title="Roll Special Secondary (2d6)" name="roll_secondary_advantage"
                    value="&{template:Skill} {{characterName=@{character_name}}} {{characterType=@{secondary_type}}} {{isSecondary=[[1]]}} {{isPrimaryBear=[[@{is_primary_bear}]]}} {{special=Special}} {{diceRoll=[[2d6kl1]]}} {{playerStat=[[@{secondary}]]}}">
                    <span name="attr_secondary_type">Criminal</span> special
                </button>
            </div>
        </div>

        <a href="#popup_rules">View Rules Summary</a>
    </div>

    <div id="popup_rules" class="popup-container">
        <a class="background" href="#" title="Close Popup"></a>
        <div class="popup rules">
            <header>
                <h2>
                    Rules Summary
                </h2>
                <a class="popup-close" href="#" title="Close Popup">×</a>
            </header>
            <div class="content">
                <p>You’re not a talking bear, per se, but you can sort of mangle human speech through your bear mouth, maybe?</p>
                <h3>Stats</h3>
                <p>You have two stats. Each starts with 3 points.</p>
                <p><strong>Bear:</strong> Use to maul stuff, run & climb, shrug off damage, scare people, and generally do bear stuff.</p>
                <p><strong>Criminal:</strong> Use to do anything not directly related to being a bear.</p>
                <h3>Actions</h3>
                <p>When you act, and the outcome is in doubt, roll a D6. If it’s equal to or under the relevant stat, you succeed. If it’s over the stat, you fail. If you’re using your bear special-skill or doing something related to your role, roll 2 D6 and pick the lowest.</p>
                <h3>Changing Stats</h3>
                <p><strong>Frustration:</strong> When the plan fails and you run into difficulty, move one point from Criminal into Bear.</p>
                <p><strong>Greed:</strong> When the plan goes off without a hitch, move one point from Bear into Criminal.</p>
                <p>You can voluntarily move one point from Bear to Criminal by doing a flashback scene in which you and the other bears plan out the heist over coffee and cigarettes in the back room of a seedy bar. You can voluntarily move one point of Criminal into Bear by eating a load of honey.</p>
                <h3> The End</h3>
                <p>If your criminal stat ever reaches 6, you are lured into a life of crime and betray the party.</p>
                <p>If your bear stat ever reaches 6, you flip out bear-style and lose it. Presumable to be picked up by animal control in half an hour or so.</p>
                <br/>
                <p><strong>Credits:</strong> Honey Heist by Grant Howitt, Roll20 template by Tyson Matanich, view it on GitHub at https://github.com/tysonmatanich/roll20-honey-heist/</p>
            </div>
        </div>
    </div>
</div>

<script type="text/worker">
const isValidStats = function (primary, secondary) {
  return (
    primary + secondary == 6 &&
    primary >= 0 &&
    primary <= 6 &&
    secondary >= 0 &&
    secondary <= 6
  );
};

const updateStats = function (eventName) {
  getAttrs(["primary", "secondary"], function (values) {
    let primary = parseInt(values.primary) || 0;
    let secondary = parseInt(values.secondary) || 0;

    if (!isValidStats(primary, secondary)) {
      primary = 3;
      secondary = 3;
    }

    if (eventName == "primary_modifier") {
      if (primary < 6) {
        primary += 1;
        secondary -= 1;
      }
    } else if (eventName == "secondary_modifier") {
      if (secondary < 6) {
        primary -= 1;
        secondary += 1;
      }
    }

    setAttrs({
      primary: primary,
      secondary: secondary,
    });
  });
};

const updateIsPrimaryBear = function () {
  getAttrs(["primary_type"], function (values) {
    if (
      values.primary_type &&
      values.primary_type.trim().toLowerCase() == "bear"
    ) {
      setAttrs({
        is_primary_bear: 1,
      });
    } else {
      setAttrs({
        is_primary_bear: 0,
      });
    }
  });
};

on("sheet:opened", function () {
  getAttrs(["primary", "secondary"], function (values) {
    if (!isValidStats(parseInt(values.primary), parseInt(values.secondary))) {
      setAttrs({
        primary: 3,
        secondary: 3,
      });
    }
  });
  updateIsPrimaryBear();
});

on("clicked:primary_modifier", function () {
  updateStats("primary_modifier");
});

on("clicked:secondary_modifier", function () {
  updateStats("secondary_modifier");
});

on("change:primary_type", function () {
  updateIsPrimaryBear();
});

</script>

<rolltemplate class="sheet-rolltemplate-Skill">
  <div class="sheet-result-container">
    {{#^rollGreater() diceRoll playerStat}}
      <div class="sheet-result">Success!</div>
    {{/^rollGreater() diceRoll playerStat}}
    {{#rollGreater() diceRoll playerStat}}
      <div class="sheet-result">Fail...</div>
    {{/rollGreater() diceRoll playerStat}}

    <div class="sheet-action-type">{{special}} {{characterType}} Action</div>

    <div class="sheet-character">by {{characterName}}</div>

    <div class="sheet-values">
      {{#^rollGreater() diceRoll playerStat}}
        <div class="sheet-success"></div>
      {{/^rollGreater() diceRoll playerStat}}
      {{#rollGreater() diceRoll playerStat}}
        <div class="sheet-fail"></div>
      {{/rollGreater() diceRoll playerStat}}
      <div class="sheet-value-result">
        {{diceRoll}}
        <span class="sheet-compare-symbol">≤</span>
        <span class="sheet-player-stat"> {{playerStat}} </span>
      </div>
    </div>

    {{#rollTotal() isPrimaryBear 1}}
      {{#isPrimary}}
        <div class="sheet-primary sheet-is-bear"></div>
      {{/isPrimary}}
      {{#isSecondary}}
        <div class="sheet-secondary sheet-is-bear"></div>
      {{/isSecondary}}
    {{/rollTotal() isPrimaryBear 1}}
    {{#rollTotal() isPrimaryBear 0}}
      {{#isPrimary}}
        <div class="sheet-primary"></div>
      {{/isPrimary}}
      {{#isSecondary}}
        <div class="sheet-secondary"></div>
      {{/isSecondary}}
    {{/rollTotal() isPrimaryBear 0}}
  </div>
</rolltemplate>
